(()=>{"use strict";var e={n:s=>{var r=s&&s.__esModule?()=>s.default:()=>s;return e.d(r,{a:r}),r},d:(s,r)=>{for(var t in r)e.o(r,t)&&!e.o(s,t)&&Object.defineProperty(s,t,{enumerable:!0,get:r[t]})},o:(e,s)=>Object.prototype.hasOwnProperty.call(e,s)};const s=require("express");var r=e.n(s);const t=require("helmet");var n=e.n(t);const o=require("cors");var a=e.n(o);const i=require("express-rate-limit");var c=e.n(i);const l=require("path");var d=e.n(l);const u=require("url"),m=require("dotenv");var g=e.n(m);const p=require("fs/promises");var w=e.n(p);const f=(0,u.fileURLToPath)("file:///media/sr79/WORKS/Projects/sr79-main/src/swish/server/handlers/UserHandler.ts"),h=d().dirname(f),y=d().join(h,"..",".data_store"),j=d().join(y,"user_index.json");let v={};async function E(){try{await w().mkdir(y),console.log("\n----Data Store established... ----\n"),await w().writeFile(j,JSON.stringify(v),"utf8"),console.log("\n---- User Index created... ----\n")}catch(e){e instanceof Error?console.log(`Internal error occurred: ${e.message}`):console.log(`Unknown error occurred: ${e}`)}}const S=(0,u.fileURLToPath)("file:///media/sr79/WORKS/Projects/sr79-main/src/swish/server/handlers/ChatHandler.ts"),U=d().dirname(S),$=d().join(U,"..",".data_store"),O=d().join($,"chat_index.json");let x={};async function I(e){try{if(e){const s=x[e.id];if(s){const r=s[e.recipient];r&&e.recipient in s?(r.preview=e.message,r.timestamp=e.timestamp,r.history.push({direction:"self",timestamp:e.timestamp,message:e.message})):s[e.recipient]={preview:e.message,timestamp:e.timestamp,history:[{direction:"self",timestamp:e.timestamp,message:e.message}]}}const r=x[e.recipient];if(r){const s=r[e.id];s&&e.id in r?(s&&e.id in r&&(s.preview=e.message),s.timestamp=e.timestamp,s.history.push({direction:"recipient",timestamp:e.timestamp,message:e.message})):r[e.id]={preview:e.message,timestamp:e.timestamp,history:[{direction:"recipient",timestamp:e.timestamp,message:e.message}]}}}await w().writeFile(O,JSON.stringify(x)),console.log("\n---- CHAT INDEX Updated... ---- \n")}catch(e){e instanceof Error?console.log(`Error Updating Chat Index: ${e.message}`):console.log(`Unknown error occurred: ${e}`)}}async function N(){await async function(){try{await w().access(y);try{const e=await w().readFile(j,"utf8");v=JSON.parse(e),console.log("\n----USER INDEX Setup successfully. ----\n")}catch(e){e instanceof Error?console.log(`user_index.json not found: ${e.message}`):console.log(`Unknown error occurred: ${e}`),await E()}}catch(e){e instanceof Error?console.log(`.data_store does not exists: ${e.message}`):console.log(`Unknown error occurred: ${e}`),await E()}console.log("\n---- Directory Configurations Loaded ----\n")}(),await async function(){try{const e=await w().readFile(O,"utf8");x=JSON.parse(e),console.log("\n----CHAT INDEX Setup successfully. ----\n")}catch(e){e instanceof Error?console.log(`chat_index.json not found: ${e.message}`):console.log(`Unknown error occurred: ${e}`),await async function(){try{await w().writeFile(O,JSON.stringify(x),"utf8"),console.log("\n---- CHAT INDEX Created... ----\n")}catch(e){e instanceof Error?console.log(`Internal error occurred: ${e.message}`):console.log(`Unknown error occurred: ${e}`)}}()}}()}const R=r().Router();R.get("/",(e,s)=>{s.sendFile("index.html",{root:"./src/swish/dist/"})}),R.post("/user",async(e,s)=>{try{const r=e.body.body,t=r.id,n=v[r.id];t&&n&&r.id in v?"password"in r?n.password===r.password?s.json({status:!0,message:"User Authenticated.",chatHistory:"sign-in"===r.authType?x[r.id]:[]}):s.json({status:!1,message:"Invalid Credentials."}):s.json({status:!0}):(v[r.id]={password:r.password},x[r.id]={},await async function(){try{await w().writeFile(j,JSON.stringify(v)),console.log("\n---- USER INDEX updated... ---- \n")}catch(e){e instanceof Error?console.log(`Internal error occurred: ${e.message})`):console.log(`Unknown error occurred: ${e}`)}}(),await I(null),s.json({status:!0}))}catch(e){console.error("Error handling user:",e.message),s.status(400).json({status:!1})}}),R.post("/user/chat",async(e,s)=>{try{const r=e.body.body;!function(e,s){if(!e||!s)return!1;const r=v[e];return!!r&&e in v&&s===r.password}(r.id,r.password)?s.status(400).json({status:!1}):(await I(r),s.status(200).json({status:!0}))}catch(e){console.log(`Error Handling Chat Session: ${e.message}`),s.status(400).json({status:!1})}}),g().config();const C=(0,u.fileURLToPath)("file:///media/sr79/WORKS/Projects/sr79-main/src/main.ts"),P=d().dirname(C),k=process.env.PORT||2795,_=r()();_.use(n()()),_.use(a()()),_.use(r().json()),_.use(c()({windowMs:9e5,max:1e3})),_.use("/swish",r().static(d().join(P,"/swish/dist"))),_.use("/swish",R),_.get("/",(e,s)=>{s.end("Channel #SR79 Active")}),_.use((e,s,r,t)=>{console.error(e.stack),r.status(500).send("Internal Server Error")}),_.use((e,s)=>{s.status(404).send("Not Found")}),async function(){try{await N(),_.listen(k,()=>{console.log(`Channel SR79 Active; Port: ${k}`)})}catch(e){console.error("Server Error during startup:",e),process.exit(1)}}()})();
//# sourceMappingURL=main.js.map